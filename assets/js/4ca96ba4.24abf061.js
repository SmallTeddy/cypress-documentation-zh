"use strict";(self.webpackChunkcypress_docusaurus_zh=self.webpackChunkcypress_docusaurus_zh||[]).push([[4758],{8882:(e,s,n)=>{n.r(s),n.d(s,{assets:()=>c,contentTitle:()=>l,default:()=>d,frontMatter:()=>r,metadata:()=>o,toc:()=>a});var t=n(5893),i=n(1151);const r={title:"API of results | Cypress Accessibility",description:"Programmatically fetch Accessibility results in a CI environment and fail your pipeline if your standards are not met.",sidebar_label:"Results API",sidebar_position:100},l="Results API",o={id:"accessibility/results-api",title:"API of results | Cypress Accessibility",description:"Programmatically fetch Accessibility results in a CI environment and fail your pipeline if your standards are not met.",source:"@site/docs/accessibility/results-api.mdx",sourceDirName:"accessibility",slug:"/accessibility/results-api",permalink:"/accessibility/results-api",draft:!1,unlisted:!1,editUrl:"https://github.com/cypress-io/cypress-documentation/tree/main/docs/accessibility/results-api.mdx",tags:[],version:"current",lastUpdatedAt:1732009455,formattedLastUpdatedAt:"Nov 19, 2024",sidebarPosition:100,frontMatter:{title:"API of results | Cypress Accessibility",description:"Programmatically fetch Accessibility results in a CI environment and fail your pipeline if your standards are not met.",sidebar_label:"Results API",sidebar_position:100},sidebar:"accessibility",previous:{title:"Axe Core\xae configuration",permalink:"/accessibility/configuration/axe-core-configuration"},next:{title:"Changelog",permalink:"/accessibility/changelog"}},c={},a=[{value:"Supported CI Providers",id:"Supported-CI-Providers",level:2},{value:"Installation",id:"Installation",level:2},{value:"Usage",id:"Usage",level:2},{value:"<strong>1. Get the Results</strong>",id:"1-Get-the-Results",level:3},{value:"<code>getAccessibilityResults</code> Arguments",id:"getAccessibilityResults-Arguments",level:4},{value:"Result Types",id:"Result-Types",level:4},{value:"<strong>2. Add to CI Workflow</strong>",id:"2-Add-to-CI-Workflow",level:3},{value:"Example Job Workflow Update:",id:"Example-Job-Workflow-Update",level:4}];function u(e){const s={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.a)(),...e.components},{AccessibilityAddon:n,TabItem:r,Tabs:l}=s;return n||h("AccessibilityAddon",!0),r||h("TabItem",!0),l||h("Tabs",!0),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(s.h1,{id:"Results-API",children:"Results API"}),"\n",(0,t.jsx)(n,{}),"\n",(0,t.jsxs)(s.p,{children:["The ",(0,t.jsx)(s.code,{children:"@cypress/extract-cloud-results"})," module provides the ",(0,t.jsx)(s.code,{children:"getAccessibilityResults"})," utility which enables you to programmatically fetch your run's Accessibility results in a CI environment. It determines the Cypress run created for the given CI workflow and will return the Accessibility results associated with that run. The results will be returned once the Cypress run has finished and the Accessibility report has been processed."]}),"\n",(0,t.jsx)(s.p,{children:"This allows you to review the results within CI and to determine if the results are acceptable or need to be addressed before code changes can merge."}),"\n",(0,t.jsx)(s.h2,{id:"Supported-CI-Providers",children:"Supported CI Providers"}),"\n",(0,t.jsx)(s.p,{children:"Fetching Accessibility results for a run supports fetching results for the following CI providers. Please see the docs below for information on general setup."}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.a,{href:"/app/continuous-integration/overview#Azure-Pipelines",children:"Azure"})," (requires Cypress v13.13.1)"]}),"\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"/app/continuous-integration/circleci",children:"CircleCI "})}),"\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"/app/continuous-integration/github-actions",children:"GitHub Actions"})}),"\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"/app/continuous-integration/gitlab-ci",children:"GitLab"})}),"\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.a,{href:"/app/continuous-integration/overview#Jenkins",children:"Jenkins"})}),"\n"]}),"\n",(0,t.jsx)(s.p,{children:"Please reach out to Cypress Support to request support for a different provider."}),"\n",(0,t.jsx)(s.h2,{id:"Installation",children:"Installation"}),"\n",(0,t.jsxs)(s.p,{children:["Install the ",(0,t.jsx)(s.code,{children:"@cypress/extract-cloud-results"})," module in your install step in CI."]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-shell",children:"npm install --force https://cdn.cypress.io/extract-cloud-results/v1/extract-cloud-results.tgz\n"})}),"\n",(0,t.jsxs)(s.admonition,{type:"caution",children:[(0,t.jsxs)(s.p,{children:["Do not check this module in as a dependency. You should install it separately outside of your normal module installation. Use ",(0,t.jsx)(s.code,{children:"--force"})," to get the latest version."]}),(0,t.jsx)(s.p,{children:"If you check this in as a dependency, your installation will fail when we update the package."})]}),"\n",(0,t.jsx)(s.h2,{id:"Usage",children:"Usage"}),"\n",(0,t.jsx)(s.h3,{id:"1-Get-the-Results",children:(0,t.jsx)(s.strong,{children:"1. Get the Results"})}),"\n",(0,t.jsxs)(s.p,{children:["Write a script using the ",(0,t.jsx)(s.code,{children:"getAccessibilityResults"})," utility to retrieve the results and perform one or more assertions to verify if the changes are acceptable. This script will be executed in CI."]}),"\n",(0,t.jsxs)(s.p,{children:["The Cypress App ",(0,t.jsx)(s.a,{href:"https://github.com/cypress-io/cypress",children:"repository"})," uses the Results API to ensure no new violations have been introduced. You can reference ",(0,t.jsx)(s.a,{href:"https://github.com/cypress-io/cypress/blob/develop/scripts/verify-accessibility-results.js",children:"this script"})," as a real example."]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-javascript",metastring:'title="scripts/verifyAccessibilityResults.js"',children:"const { getAccessibilityResults } = require('@cypress/extract-cloud-results')\n\ngetAccessibilityResults({\n  projectId: '...', // optional if set from env\n  recordKey: '...', // optional if set from env\n  runTags: [process.env.RUN_TAGS], // required if recording multiple runs\n}).then((results) => {\n  const { runNumber, accessibilityReportUrl, summary, rules } = results\n  const { total } = summary.violationCounts\n\n  console\n    .log(\n      `Received ${summary.isPartialReport ? 'partial' : ''} results for run #${runNumber}.`\n    )\n    .console.log(`See full report at ${accessibilityReportUrl}.`)\n\n  // write your logic to conditionally fail based on the results\n  if (total === 0) {\n    console.log('No Accessibility violations detected!')\n    return\n  }\n\n  const { critical, serious, moderate, minor } = summary.violationCounts\n\n  console.log(`${total} Accessibility violations were detected:`)\n  console.log(`  - ${critical} critical`)\n  console.log(`  - ${serious} serious`)\n  console.log(`  - ${moderate} moderate`)\n  console.log(`  - ${minor} minor.`)\n\n  const newRuleViolations = rules.filter((rule) => {\n    return !rulesWithExistingViolations.includes(rule.name)\n  })\n\n  if (newRuleViolations.length > 0) {\n    console.error(\n      'The following rules were violated that were previously passing:'\n    )\n    console.error(newRuleViolations)\n    throw new Error(\n      `${newRuleViolations.length} rule regressions were introduced and must be fixed.`\n    )\n  }\n\n  if (total < rulesWithExistingViolations.length) {\n    console.warn(\n      `It seems you have resolved ${rulesWithExistingViolations.length - total} rule(s). Remove them from the list of problematic rules so regressions are not introduced.`\n    )\n  }\n\n  console.log('No new Accessibility violations detected!')\n\n  /**\n   * The list of rules that currently have 1+ elements that have been flagged with\n   * violations within the Cypress Accessibility report that need to be addressed.\n   *\n   * Once the violation is fixed in the Accessibility report,\n   * the fixed rule should be removed from this list.\n   *\n   * View the Accessibility report for the Cypress run in the Cloud\n   * for more details on how to address these failures.\n   */\n  const rulesWithExistingViolations = [\n    'aria-required-children',\n    'empty-heading',\n    'aria-dialog-name',\n    'link-in-text-block',\n    'list',\n  ]\n})\n"})}),"\n",(0,t.jsxs)(s.h4,{id:"getAccessibilityResults-Arguments",children:[(0,t.jsx)(s.code,{children:"getAccessibilityResults"})," Arguments"]}),"\n",(0,t.jsxs)(s.p,{children:[(0,t.jsx)(s.code,{children:"getAccessibilityResults"})," uses the following attributes to identify the Cypress run and return the Accessibility results:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-javascript",children:"getAccessibilityResults({\n  // The Cypress project ID.\n  // Optional if the CYPRESS_PROJECT_ID env is set\n  // Can be explicitly passed to override the env var\n  projectId: string\n\n  // The project's record key.\n  // Optional if the CYPRESS_RECORD_KEY env is set\n  // Can be explicitly passed to override the env var\n  recordKey: string\n\n  // The run tags associated with the run.\n  // Required IF you are recording multiple Cypress runs from a single CI build.\n  // Pass the run tags you used when recording in each run\n  // See below for more information\n  runTags: string[]\n})\n"})}),"\n",(0,t.jsx)(s.h4,{id:"Result-Types",children:"Result Types"}),"\n",(0,t.jsx)(s.p,{children:"The Accessibility results for the run are returned as an object containing the following data:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-javascript",children:"{\n  // The run number of the identified build.\n  runNumber: number\n\n  // The run url for the identified build.\n  runUrl: 'https://cloud.cypress.io/projects/:project_id/runs/:run_number'\n\n  // The status of the identified build.\n  runStatus: 'passed' | 'failed' | 'errored' | 'timedOut' | 'cancelled' | 'noTests'\n\n   // The url that deep links into the summarized Accessibility report for the identified build.\n  accessibilityReportUrl: 'https://cloud.cypress.io/[...]'\n\n  // The axe-core library version used when generating the Accessibility report.\n  // See https://github.com/dequelabs/axe-core.\n  axeVersion: '4.9.1'\n\n  summary: {\n    // Indicates whether a complete Accessibility report was generated.\n    // For example, if a run was cancelled and the report expected to run\n    // for 20 specs, but only 10 ran, this would result in a partial report.\n    isPartialReport: boolean\n\n    // The total detected violations and the breakdown by rule severity.\n    violationCounts: {\n      // The count of unique rules that detected a violation.\n      total: number,\n      // The count of unique critical rules that detected a violation.\n      critical: number,\n      // The count of unique serious rules that detected a violation.\n      serious: number,\n      // The count of unique moderate rules that detected a violation.\n      moderate: number,\n      // The count of unique minor rules that detected a violation.\n      minor: number,\n    },\n  }\n\n  // The list of violated rules.\n  rules: [{\n    // The name of the rule. See https://github.com/dequelabs/axe-core/blob/develop/doc/rule-descriptions.md.\n    name: string\n    // The likely impact the rule has on a user with a disability.\n    severity: 'critical' | 'serious' | 'moderate' | 'minor'\n    // The status of the rule for the run.\n    status: 'violation'\n    // The url that deep links the report for this specific rule violation.\n    accessibilityReportUrl: 'https://cloud.cypress.io/[...]'\n  }]\n}\n"})}),"\n",(0,t.jsx)(s.h3,{id:"2-Add-to-CI-Workflow",children:(0,t.jsx)(s.strong,{children:"2. Add to CI Workflow"})}),"\n",(0,t.jsx)(s.p,{children:"In your CI workflow that runs your Cypress tests,"}),"\n",(0,t.jsxs)(s.ol,{children:["\n",(0,t.jsxs)(s.li,{children:["Update your install job to install the ",(0,t.jsx)(s.code,{children:"@cypress/extract-cloud-results"})," module."]}),"\n",(0,t.jsxs)(s.li,{children:["Pass in the necessary arguments to ",(0,t.jsx)(s.code,{children:"getAccessibilityResults"}),"."]}),"\n",(0,t.jsx)(s.li,{children:"Add a new step to the job that runs your Cypress tests to verify the Accessibility results."}),"\n"]}),"\n",(0,t.jsxs)(s.admonition,{type:"info",children:[(0,t.jsxs)(s.p,{children:["If you record multiple runs in a single CI build, you must record these runs using the ",(0,t.jsx)(s.code,{children:"--tag"})," parameter and then call ",(0,t.jsx)(s.code,{children:"getAccessibilityResults"})," with the ",(0,t.jsx)(s.code,{children:"runTags"})," argument for each run."]}),(0,t.jsx)(s.p,{children:"This is necessary to identify each unique run and return a corresponding set of results. The tags are how each run is uniquely identified."}),(0,t.jsx)(s.p,{children:(0,t.jsx)(s.strong,{children:"Example"})}),(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["Let's imagine that within a single CI build you call ",(0,t.jsx)(s.code,{children:"cypress run --record"})," multiple times because you're running one set of tests against a ",(0,t.jsx)(s.code,{children:"staging"})," environment, followed by a ",(0,t.jsx)(s.code,{children:"production"})," environment."]}),"\n",(0,t.jsxs)(s.li,{children:["In this scenario, you pass a different ",(0,t.jsx)(s.code,{children:"--tag"})," to each cypress run","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.code,{children:"cypress run --record --tag staging"})}),"\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.code,{children:"cypress run --record --tag production"})}),"\n"]}),"\n"]}),"\n",(0,t.jsxs)(s.li,{children:["When calling ",(0,t.jsx)(s.code,{children:"getAccessibilityResults"})," you would then pass these same tags to get the unique set of results for each run","\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.code,{children:"getAccessibilityResults({ runTags: ['staging']})"})}),"\n",(0,t.jsx)(s.li,{children:(0,t.jsx)(s.code,{children:"getAccessibilityResults({ runTags: ['production']})"})}),"\n"]}),"\n"]}),"\n"]})]}),"\n",(0,t.jsx)(s.h4,{id:"Example-Job-Workflow-Update",children:"Example Job Workflow Update:"}),"\n",(0,t.jsxs)(l,{groupId:"a11y-results-api",children:[(0,t.jsx)(r,{value:"GitHub Actions",active:!0,children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-diff",metastring:'title="test_cypress.yaml"',children:"name: My Workflow\non: push\n\nenv:\n  CYPRESS_RECORD_KEY: ${{ secrets.CYPRESS_RECORD_KEY }}\n\njobs:\n  run-cypress:\n    runs-on: ubuntu-latest\n    steps:\n      - name: Checkout\n        uses: actions/checkout@v3\n      - name: install\n        run: npm install\n      - name: Run\n        run: npx cypress run --record\n+     - name: Verify Accessibility Results\n+       run: |\n+          npm install --force https://cdn.cypress.io/extract-cloud-results/v1/extract-cloud-results.tgz\n+          node ./scripts/verifyAccessibilityResults.js\n"})})}),(0,t.jsx)(r,{value:"GitLab",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-diff",metastring:'title=".git-ci.yml"',children:"name: Run Cypress Tests\n\nimage: node:latest\n\nstages:\n  - test\n\nrun-cypress:\n  stage: test\n  secrets:\n    CYPRESS_RECORD_KEY:\n      vault: vault/cypressRecordKey\n  script:\n    - npm install\n    - npx cypress run --record\n+   - npm install --force https://cdn.cypress.io/extract-cloud-results/v1/extract-cloud-results.tgz\n+   - node ./scripts/verifyAccessibilityResults.js\n"})})}),(0,t.jsx)(r,{value:"Jenkins",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-diff",children:"pipeline {\n  agent {\n    docker {\n      image 'cypress/base:latest'\n    }\n  }\n\n  environment {\n    CYPRESS_PROJECT_ID: 'xxxx'\n    CYPRESS_RECORD_KEY = credentials('cypress-record-key')\n  }\n\n  stages {\n    stage('build and test') {\n      steps {\n        sh 'npm ci'\n        sh 'npx cypress run --record'\n      }\n    }\n\n+   stage('Verify Accessibility Results') {\n+     steps {\n+       sh 'npm install --force https://cdn.cypress.io/extract-cloud-results/v1/extract-cloud-results.tgz'\n+       sh 'node ./scripts/verifyAccessibilityResults.js'\n+     }\n+   }\n  }\n}\n"})})}),(0,t.jsx)(r,{value:"Azure",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-diff",children:"jobs:\n  - job: run_tests\n    pool:\n      vmImage: 'ubuntu-latest'\n    steps:\n      - task: NodeTool@0\n        inputs:\n          versionSpec: '20.x'\n          displayName: 'Install Node.js'\n\n      - script: npm i\n        displayName: 'Install npm dependencies'\n\n      - script: npx cypress run --record\n        displayName: 'Run Cypress tests'\n        env:\n          # avoid warnings about terminal\n          TERM: xterm\n          CYPRESS_RECORD_KEY: $(CYPRESS_RECORD_KEY)\n\n+     - script: |\n+           npm install --force https://cdn.cypress.io/extract-cloud-results/v1/extract-cloud-results.tgz\n+           node ./scripts/verifyAccessibilityResults.js\n+       displayName: 'Verify Accessibility Results'\n+       env:\n+         CYPRESS_PROJECT_ID: $(CYPRESS_PROJECT_ID)\n+         CYPRESS_RECORD_KEY: $(CYPRESS_RECORD_KEY)\n"})})}),(0,t.jsx)(r,{value:"CircleCI",children:(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-diff",children:"version: 2.1\n\njobs:\n  linux-test:\n    docker:\n      - image: cypress/base:latest\n\n    working_directory: ~/repo\n    steps:\n      - checkout\n      - run: npm install\n      - run: npx run cypress:run --record\n+     - run: npm install --force https://cdn.cypress.io/extract-cloud-results/v1/extract-cloud-results.tgz\n+     - run: node ./scripts/verifyAccessibilityResults.js\n\nworkflows:\n  version: 2\n  tests:\n    jobs:\n      - run-cypress\n"})})})]})]})}function d(e={}){const{wrapper:s}={...(0,i.a)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(u,{...e})}):u(e)}function h(e,s){throw new Error("Expected "+(s?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}},1151:(e,s,n)=>{n.d(s,{Z:()=>o,a:()=>l});var t=n(7294);const i={},r=t.createContext(i);function l(e){const s=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(s):{...s,...e}}),[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),t.createElement(r.Provider,{value:s},e.children)}}}]);