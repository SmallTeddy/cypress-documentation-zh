"use strict";(self.webpackChunkcypress_docusaurus_zh=self.webpackChunkcypress_docusaurus_zh||[]).push([[4117],{9104:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>a,toc:()=>d});var t=i(5893),s=i(1151);const o={title:"Azure Active Directory Authentication"},r=void 0,a={id:"app/guides/authentication-testing/azure-active-directory-authentication",title:"Azure Active Directory Authentication",description:"What you'll learn",source:"@site/docs/app/guides/authentication-testing/azure-active-directory-authentication.mdx",sourceDirName:"app/guides/authentication-testing",slug:"/app/guides/authentication-testing/azure-active-directory-authentication",permalink:"/app/guides/authentication-testing/azure-active-directory-authentication",draft:!1,unlisted:!1,editUrl:"https://github.com/cypress-io/cypress-documentation/tree/main/docs/app/guides/authentication-testing/azure-active-directory-authentication.mdx",tags:[],version:"current",lastUpdatedAt:1732009455,formattedLastUpdatedAt:"Nov 19, 2024",frontMatter:{title:"Azure Active Directory Authentication"},sidebar:"app",previous:{title:"Auth0 Integration",permalink:"/app/guides/authentication-testing/auth0-authentication"},next:{title:"Google Authentication",permalink:"/app/guides/authentication-testing/google-authentication"}},c={},d=[{value:"<Icon></Icon> What you&#39;ll learn",id:"What-youll-learn",level:5},{value:"Microsoft AAD Application Setup",id:"Microsoft-AAD-Application-Setup",level:2},{value:"Configuring Cypress to use Microsoft AAD",id:"Configuring-Cypress-to-use-Microsoft-AAD",level:2},{value:"Login with <code>cy.origin()</code>",id:"Login-with-cyorigin",level:2},{value:"See also",id:"See-also",level:2}];function l(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h5:"h5",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.a)(),...e.components},{CypressConfigFileTabs:i,DocsVideo:o,Icon:r}=n;return i||u("CypressConfigFileTabs",!0),o||u("DocsVideo",!0),r||u("Icon",!0),(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.admonition,{type:"info",children:[(0,t.jsxs)(n.h5,{id:"What-youll-learn",children:[(0,t.jsx)(r,{name:"question-circle",color:"#4BBFD2"})," What you'll learn"]}),(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"How to set up Cypress to test against an Azure Active Directory web app"}),"\n",(0,t.jsxs)(n.li,{children:["How to authenticate with Azure Active Directory using ",(0,t.jsx)(n.code,{children:"cy.origin()"})]}),"\n"]})]}),"\n",(0,t.jsxs)(n.p,{children:["This guide is designed for testing against a Single Page Application (SPA) that\nuses\n",(0,t.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-whatis",children:"Azure Active Directory"}),"\n(AAD) to authenticate users. For this guide, the Microsoft Authentication\nLibrary\n",(0,t.jsx)(n.a,{href:"https://www.npmjs.com/package/@azure/msal-browser",children:(0,t.jsx)(n.code,{children:"@azure/msal-browser"})}),"\npackage is used by the web app to broker this authentication."]}),"\n",(0,t.jsx)(n.p,{children:"This guide can also serve as a foundation for testing other web apps with\nCypress that use Azure Active Directory services with other frameworks, such as\nReact, Angular, or Vue."}),"\n",(0,t.jsx)(n.h2,{id:"Microsoft-AAD-Application-Setup",children:"Microsoft AAD Application Setup"}),"\n",(0,t.jsxs)(n.p,{children:["For this guide, we are mainly going to focus on setting up Cypress to test\nagainst an Azure Active Directory web app. Please clone the\n",(0,t.jsx)(n.a,{href:"https://github.com/Azure-Samples/ms-identity-javascript-tutorial/tree/c1956b658efa331bb5df11a0038ad32d12dad3ce/1-Authentication/1-sign-in",children:"Microsoft Identity JavaScript Tutorial"}),"\nand follow the steps to set up your application."]}),"\n",(0,t.jsxs)(n.p,{children:["Once set up, you'll need to modify a few things in the ",(0,t.jsx)(n.code,{children:"App/index.html"})," file:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Remove any\n",(0,t.jsx)(n.a,{href:"https://developer.mozilla.org/en-US/docs/Web/Security/Subresource_Integrity",children:(0,t.jsx)(n.code,{children:"integrity"})}),"\nattributes inside ",(0,t.jsx)(n.code,{children:"<script>"})," tags. This is to prevent any SRI attribute\nmismatches, which can happen since Cypress must rewrite any\n",(0,t.jsx)(n.a,{href:"/app/references/configuration#modifyObstructiveCode",children:"framebusting code"}),".\nThis is recommended only when an application is under test."]}),"\n",(0,t.jsxs)(n.li,{children:["Uncomment the ",(0,t.jsx)(n.code,{children:"authRedirect.js"})," ",(0,t.jsx)(n.code,{children:"<script>"})," tag and comment out the\n",(0,t.jsx)(n.code,{children:"authPopup.js"})," ",(0,t.jsx)(n.code,{children:"<script>"})," tag. Authentication\n",(0,t.jsx)(n.a,{href:"/app/references/trade-offs#Permanent-trade-offs",children:"Pop ups"})," will not work\ninside of Cypress."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["Inside ",(0,t.jsx)(n.code,{children:"server.js"}),", you'll see a reference to ",(0,t.jsx)(n.code,{children:"express-rate-limit"}),", which\nlimits each window to 100 requests per 15 minutes. Under test, your application\nwill likely exceed this as you will be reloading your application and making\nrequests to broker/verify authentication. For this demo, you can either"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Remove the rate limiting code (recommended for demo purposes only)."}),"\n",(0,t.jsx)(n.li,{children:"Implement a strategy to increase the rate limit under test."}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["When finished, your SPA should be running on ",(0,t.jsx)(n.code,{children:"http://localhost:3000"})," and be\nproperly configured to run with Azure Active Directory and Cypress."]}),"\n",(0,t.jsx)(n.h2,{id:"Configuring-Cypress-to-use-Microsoft-AAD",children:"Configuring Cypress to use Microsoft AAD"}),"\n",(0,t.jsxs)(n.p,{children:["To have access to test user credentials within our tests, we need to configure\nCypress to use the\n",(0,t.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-whatis",children:"Azure Active Directory"}),"\nuser credentials for a given user in your tenant. These user credentials should\nbe set in the ",(0,t.jsx)(n.code,{children:"cypress.env.json"})," file inside the root directory of your project."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",metastring:'title="cypress.env.json"',children:'{\n  "aad_username": "AAD_USERNAME",\n  "aad_password": "AAD_PASSWORD",\n  "aad_name": "AAD_NAME"\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Also, to authenticate with Azure Active Directory, you'll need to enable the\n",(0,t.jsx)(n.a,{href:"/app/guides/cross-origin-testing#Modifying-Obstructive-Third-Party-Code",children:(0,t.jsx)(n.code,{children:"experimentalModifyObstructiveThirdPartyCode"})}),"\nconfiguration option in the e2e configuration. If not enabled, your\nauthentication workflow will enter an infinite redirect loop."]}),"\n",(0,t.jsxs)(i,{children:[(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",metastring:"",children:"const { defineConfig } = require('cypress')\n\nmodule.exports = defineConfig({\n  e2e: {\n    experimentalModifyObstructiveThirdPartyCode: true,\n  },\n})\n"})}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-typescript",metastring:"",children:"import { defineConfig } from 'cypress'\n\nexport default defineConfig({\n  e2e: {\n    experimentalModifyObstructiveThirdPartyCode: true,\n  },\n})\n"})})]}),"\n",(0,t.jsxs)(n.h2,{id:"Login-with-cyorigin",children:["Login with ",(0,t.jsx)(n.a,{href:"/api/commands/origin",children:(0,t.jsx)(n.code,{children:"cy.origin()"})})]}),"\n",(0,t.jsxs)(n.p,{children:["Next, we'll write a custom command called ",(0,t.jsx)(n.code,{children:"loginToAAD"})," to perform a login to\n",(0,t.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/active-directory/fundamentals/active-directory-whatis",children:"Azure Active Directory"}),".\nThis command will use ",(0,t.jsx)(n.a,{href:"/api/commands/origin",children:(0,t.jsx)(n.code,{children:"cy.origin()"})})," to"]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Navigate to the Azure Active Directory login page on\n",(0,t.jsx)(n.code,{children:"login.microsoftonline.com"})]}),"\n",(0,t.jsx)(n.li,{children:"Input user credentials"}),"\n",(0,t.jsx)(n.li,{children:"Sign in and redirect back to the demo application"}),"\n",(0,t.jsxs)(n.li,{children:["Cache the results with ",(0,t.jsx)(n.a,{href:"/api/commands/session",children:(0,t.jsx)(n.code,{children:"cy.session()"})})]}),"\n"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",metastring:'title="cypress/support/commands.ts"',children:"function loginViaAAD(username: string, password: string) {\n  cy.visit('http://localhost:3000/')\n  cy.get('button#signIn').click()\n\n  // Login to your AAD tenant.\n  cy.origin(\n    'login.microsoftonline.com',\n    {\n      args: {\n        username,\n      },\n    },\n    ({ username }) => {\n      cy.get('input[type=\"email\"]').type(username, {\n        log: false,\n      })\n      cy.get('input[type=\"submit\"]').click()\n    }\n  )\n\n  // depending on the user and how they are registered with Microsoft, the origin may go to live.com\n  cy.origin(\n    'login.live.com',\n    {\n      args: {\n        password,\n      },\n    },\n    ({ password }) => {\n      cy.get('input[type=\"password\"]').type(password, {\n        log: false,\n      })\n      cy.get('input[type=\"submit\"]').click()\n      cy.get('#idBtn_Back').click()\n    }\n  )\n\n  // Ensure Microsoft has redirected us back to the sample app with our logged in user.\n  cy.url().should('equal', 'http://localhost:3000/')\n  cy.get('#welcome-div').should(\n    'contain',\n    `Welcome ${Cypress.env('aad_username')}!`\n  )\n}\n\nCypress.Commands.add('loginToAAD', (username: string, password: string) => {\n  const log = Cypress.log({\n    displayName: 'Azure Active Directory Login',\n    message: [`\ud83d\udd10 Authenticating | ${username}`],\n    autoEnd: false,\n  })\n  log.snapshot('before')\n\n  loginViaAAD(username, password)\n\n  log.snapshot('after')\n  log.end()\n})\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Now, we can use our ",(0,t.jsx)(n.code,{children:"loginToAAD"})," command in the test. Below is our test to login\nas a user via Azure Active Directory and run a basic sanity check."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-js",metastring:'title="auth.cy.js"',children:"describe('Azure Active Directory Authentication', () => {\n  beforeEach(() => {\n    // log into Azure Active Directory through our sample SPA using our custom command\n    cy.loginToAAD(Cypress.env('aad_username'), Cypress.env('aad_password'))\n    cy.visit('http://localhost:3000')\n  })\n\n  it('verifies the user logged in has the correct name', () => {\n    cy.get('#table-body-div td:contains(\"name\") + td').should(\n      'contain',\n      `${Cypress.env('aad_name')}`\n    )\n  })\n\n  it('verifies the user logged in has the correct preferred name', () => {\n    cy.get('#table-body-div td:contains(\"preferred_username\") + td').should(\n      'contain',\n      `${Cypress.env('aad_username')}`\n    )\n  })\n})\n"})}),"\n",(0,t.jsx)(o,{src:"https://vimeo.com/789095126",title:"Azure Active Directory authentication with cy.origin()"}),"\n",(0,t.jsx)(n.p,{children:"We now have working authentication and tests! But we are logging in before every\ntest, which is not only time consuming, but also can lead to API rate limiting\ndue to the number of requests."}),"\n",(0,t.jsxs)(n.p,{children:["For this, we can refactor our login command to take advantage of\n",(0,t.jsx)(n.a,{href:"/api/commands/session",children:(0,t.jsx)(n.code,{children:"cy.session()"})})," to store our logged in user's tokens\nand/or cookies so we don't have to reauthenticate before every test."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-ts",metastring:'title="cypress/support/commands.ts"',children:"Cypress.Commands.add('loginToAAD', (username: string, password: string) => {\n  cy.session(\n    `aad-${username}`,\n    () => {\n      const log = Cypress.log({\n        displayName: 'Azure Active Directory Login',\n        message: [`\ud83d\udd10 Authenticating | ${username}`],\n        // @ts-ignore\n        autoEnd: false,\n      })\n\n      log.snapshot('before')\n\n      loginViaAAD(username, password)\n\n      log.snapshot('after')\n      log.end()\n    },\n    {\n      validate: () => {\n        // this is a very basic form of session validation for this demo.\n        // depending on your needs, something more verbose might be needed\n        cy.visit('http://localhost:3000')\n        cy.get('#welcome-div').should(\n          'contain',\n          `Welcome ${Cypress.env('aad_username')}!`\n        )\n      },\n    }\n  )\n})\n"})}),"\n",(0,t.jsx)(o,{src:"https://vimeo.com/789095038",title:"Azure Active Directory authentication with cy.session()"}),"\n",(0,t.jsxs)(n.p,{children:["With the use of ",(0,t.jsx)(n.a,{href:"/api/commands/session",children:(0,t.jsx)(n.code,{children:"cy.session()"})}),", our tests should now\nrun quicker!"]}),"\n",(0,t.jsxs)(n.p,{children:["We hope this guide was able to get you up and running with\n",(0,t.jsx)(n.a,{href:"/api/commands/origin",children:(0,t.jsx)(n.code,{children:"cy.origin()"})})," and\n",(0,t.jsx)(n.a,{href:"/api/commands/session",children:(0,t.jsx)(n.code,{children:"cy.session()"})}),". If you ran into any issues while\nfollowing this guide, or have any feedback, please let us know and submit a\n",(0,t.jsx)(n.a,{href:"https://github.com/cypress-io/cypress-documentation/issues/new/choose",children:"Github issue"}),".\nHappy testing!"]}),"\n",(0,t.jsx)(n.h2,{id:"See-also",children:"See also"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"/app/guides/cross-origin-testing",children:"Cross Origin Testing Guide"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"/app/guides/authentication-testing/amazon-cognito-authentication",children:"AWS Cognito Authentication Guide"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"/app/guides/authentication-testing/okta-authentication",children:"Okta Authentication Guide"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"/api/commands/origin",children:(0,t.jsx)(n.code,{children:"cy.origin()"})})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{href:"/api/commands/session",children:(0,t.jsx)(n.code,{children:"cy.session()"})})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(l,{...e})}):l(e)}function u(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}},1151:(e,n,i)=>{i.d(n,{Z:()=>a,a:()=>r});var t=i(7294);const s={},o=t.createContext(s);function r(e){const n=t.useContext(o);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),t.createElement(o.Provider,{value:n},e.children)}}}]);