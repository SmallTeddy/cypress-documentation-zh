"use strict";(self.webpackChunkcypress_docusaurus_zh=self.webpackChunkcypress_docusaurus_zh||[]).push([[5383],{6183:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>r,metadata:()=>i,toc:()=>d});var s=t(5893),o=t(1151);const r={title:"Code Coverage"},c=void 0,i={id:"app/tooling/code-coverage",title:"Code Coverage",description:"What you'll learn",source:"@site/docs/app/tooling/code-coverage.mdx",sourceDirName:"app/tooling",slug:"/app/tooling/code-coverage",permalink:"/app/tooling/code-coverage",draft:!1,unlisted:!1,editUrl:"https://github.com/cypress-io/cypress-documentation/tree/main/docs/app/tooling/code-coverage.mdx",tags:[],version:"current",lastUpdatedAt:1732009455,formattedLastUpdatedAt:"Nov 19, 2024",frontMatter:{title:"Code Coverage"},sidebar:"app",previous:{title:"IDE Integration",permalink:"/app/tooling/IDE-integration"},next:{title:"Reporters",permalink:"/app/tooling/reporters"}},a={},d=[{value:"<Icon></Icon> What you&#39;ll learn",id:"What-youll-learn",level:5},{value:"Introduction",id:"Introduction",level:2},{value:"Code Coverage",id:"Code-Coverage",level:3},{value:"UI Coverage",id:"UI-Coverage",level:3},{value:"Instrumenting code",id:"Instrumenting-code",level:2},{value:"Using NYC",id:"Using-NYC",level:3},{value:"Using code transpilation pipeline",id:"Using-code-transpilation-pipeline",level:3},{value:"E2E code coverage",id:"E2E-code-coverage",level:2},{value:"Install the plugin",id:"Install-the-plugin",level:3},{value:"See code coverage summary",id:"See-code-coverage-summary",level:3},{value:"Code coverage as a guide",id:"Code-coverage-as-a-guide",level:2},{value:"Combining code coverage from parallel tests",id:"Combining-code-coverage-from-parallel-tests",level:2},{value:"E2E and unit code coverage",id:"E2E-and-unit-code-coverage",level:2},{value:"Full stack code coverage",id:"Full-stack-code-coverage",level:2},{value:"Videos",id:"Videos",level:2},{value:"How to instrument react-scripts web application for code coverage",id:"How-to-instrument-react-scripts-web-application-for-code-coverage",level:4},{value:"Get code coverage reports from Cypress tests",id:"Get-code-coverage-reports-from-Cypress-tests",level:4},{value:"Excluding code from code coverage reports",id:"Excluding-code-from-code-coverage-reports",level:4},{value:"Check code coverage robustly using 3rd party tool",id:"Check-code-coverage-robustly-using-3rd-party-tool",level:4},{value:"Adding code coverage badge to your project",id:"Adding-code-coverage-badge-to-your-project",level:4},{value:"Show code coverage in commit status check",id:"Show-code-coverage-in-commit-status-check",level:4},{value:"Checking code coverage on pull request",id:"Checking-code-coverage-on-pull-request",level:4},{value:"Examples",id:"Examples",level:2},{value:"See also",id:"See-also",level:2}];function l(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",h5:"h5",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.a)(),...e.components},{CypressConfigFileTabs:t,DocsImage:r,DocsVideo:c,E2EOrCtTabs:i,Icon:a}=n;return t||p("CypressConfigFileTabs",!0),r||p("DocsImage",!0),c||p("DocsVideo",!0),i||p("E2EOrCtTabs",!0),a||p("Icon",!0),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)(n.admonition,{type:"info",children:[(0,s.jsxs)(n.h5,{id:"What-youll-learn",children:[(0,s.jsx)(a,{name:"question-circle",color:"#4BBFD2"})," What you'll learn"]}),(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"The difference between Code Coverage and Cypress's UI Coverage"}),"\n",(0,s.jsx)(n.li,{children:"How to instrument your application code for code coverage"}),"\n",(0,s.jsx)(n.li,{children:"How to collect code coverage from Cypress tests"}),"\n",(0,s.jsx)(n.li,{children:"How to merge code coverage from parallel tests"}),"\n",(0,s.jsx)(n.li,{children:"How to collect code coverage from different testing types"}),"\n"]})]}),"\n",(0,s.jsx)(n.h2,{id:"Introduction",children:"Introduction"}),"\n",(0,s.jsx)(n.p,{children:"As you write more and more end-to-end tests, you will find yourself wondering -\ndo I need to write more tests? Are there parts of the application still\nuntested? Are there parts of the application that perhaps are tested too much?"}),"\n",(0,s.jsx)(n.p,{children:"Cypress offers a couple of solutions to help answer these questions."}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.a,{href:"#Code-Coverage",children:"Code coverage"})})," - find out which lines of the application's source code were"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.a,{href:"#UI-Coverage",children:"UI coverage"})})," - find out which parts of the UI were tested\nexecuted"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"Code-Coverage",children:"Code Coverage"}),"\n",(0,s.jsxs)(n.p,{children:["Code coverage is a metric that helps you understand how much of your application\ncode is covered by your tests. If there are important\nsections of the application's logic that ",(0,s.jsx)(n.strong,{children:"were not"})," executed from the tests,\nthen a new test can be added to ensure that part of our application logic is\ntested."]}),"\n",(0,s.jsxs)(n.p,{children:["Computing the source code lines that were executed during the test is done\nthrough ",(0,s.jsx)(n.strong,{children:"code coverage"}),". Code coverage requires inserting additional counters\ninto your source code before running it using ",(0,s.jsx)(n.strong,{children:"instrumentation"}),".\n.\nThis document will be focused on code coverage and the instrumentation required to set it up."]}),"\n",(0,s.jsx)(n.h3,{id:"UI-Coverage",children:"UI Coverage"}),"\n",(0,s.jsx)(n.p,{children:"UI Coverage is a visual test coverage report based on the interactive elements that make up your application.\nIt highlights areas of missed test coverage directly within every page of your application,\nthat you can use to make data-driven testing decisions."}),"\n",(0,s.jsx)(n.p,{children:"UI Coverage also seamlessly integrates with your Cypress tests, building on the tests you've already\nwritten \u2014 no extra instrumentation is required like with code coverage."}),"\n",(0,s.jsxs)(n.p,{children:["To learn more about UI coverage,\nplease see our ",(0,s.jsx)(n.a,{href:"/ui-coverage/get-started/introduction",children:"UI Coverage"})," guide."]}),"\n",(0,s.jsx)(r,{src:"/img/ui-coverage/get-started/uicov-docs-1.gif",alt:"UI Coverage demo showing UI of Cloud product"}),"\n",(0,s.jsx)(n.h2,{id:"Instrumenting-code",children:"Instrumenting code"}),"\n",(0,s.jsx)(c,{src:"https://youtube.com/embed/C8g5X4vCZJA",title:"Complete Code Coverage with Cypress"}),"\n",(0,s.jsx)(n.p,{children:"Instrumentation takes code that looks like this..."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",metastring:"title='add.js'",children:"function add(a, b) {\n  return a + b\n}\nmodule.exports = { add }\n"})}),"\n",(0,s.jsxs)(n.p,{children:["...and parses it to find all functions, statements, and branches and then\ninserts ",(0,s.jsx)(n.strong,{children:"counters"})," into the code. For the above code it might look like this:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'// this object counts the number of times each\n// function and each statement is executed\nconst c = (window.__coverage__ = {\n  // "f" counts the number of times each function is called\n  // we only have a single function in the source code thus it starts with [0]\n  f: [0],\n  // "s" counts the number of times each statement is called\n  // we have 3 statements and they all start with 0\n  s: [0, 0, 0],\n})\n\n// the original code + increment statements\n// uses "c" alias to "window.__coverage__" object\n// the first statement defines the function, let\'s increment it\nc.s[0]++\nfunction add(a, b) {\n  // function is called and then the 2nd statement\n  c.f[0]++\n  c.s[1]++\n\n  return a + b\n}\n// 3rd statement is about to be called\nc.s[2]++\nmodule.exports = { add }\n'})}),"\n",(0,s.jsx)(n.p,{children:"Imagine we load the above instrumented source file from our test spec file.\nImmediately some counters will be incremented!"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",metastring:"title='add.cy.js'",children:'const { add } = require(\'./add\')\n// JavaScript engine has parsed and evaluated "add.js" source code\n// which ran some of the increment statements\n// __coverage__ has now\n// f: [0] - function "add" was NOT executed\n// s: [1, 0, 1] - first and third counters were incremented\n// but the statement inside function "add" was NOT executed\n'})}),"\n",(0,s.jsxs)(n.p,{children:["We want to make sure every statement and function in the file ",(0,s.jsx)(n.code,{children:"add.js"})," has been\nexecuted by our tests at least once. Thus we write a test:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",metastring:"title='add.cy.js'",children:"const { add } = require('./add')\n\nit('adds numbers', () => {\n  expect(add(2, 3)).to.equal(5)\n})\n"})}),"\n",(0,s.jsxs)(n.p,{children:["When the test calls ",(0,s.jsx)(n.code,{children:"add(2, 3)"}),', the counter increments inside the "add"\nfunction are executed, and the coverage object becomes:']}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'{\n  // "f" keeps count of times each function was called\n  // we only have a single function in the source code\n  // thus it starts with [0]\n  f: [1],\n  // "s" keeps count of times each statement was called\n  // we have 3 statements, and they all start with 0\n  s: [1, 1, 1]\n}\n'})}),"\n",(0,s.jsx)(n.p,{children:"This single test has achieved 100% code coverage - every function and every\nstatement has been executed at least once. But, in real world applications,\nachieving 100% code coverage requires multiple tests."}),"\n",(0,s.jsx)(n.p,{children:"Once the tests finish, the coverage object can be serialized and saved to disk\nso that a human-friendly report can be generated. The collected coverage\ninformation can also be sent to external services and help during pull request\nreviews."}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:['If you are unfamiliar with code coverage or want to learn more, take a look at\nthe "Understanding JavaScript Code Coverage" blog post\n',(0,s.jsx)(n.a,{href:"https://medium.com/engineering-semantics3/understanding-code-coverage-1074e8fccce0/",children:"Part 1"}),"\nand\n",(0,s.jsx)(n.a,{href:"https://medium.com/engineering-semantics3/understanding-javascript-code-coverage-part-2-9aedaa5119e5/",children:"Part 2"}),"."]})}),"\n",(0,s.jsxs)(n.p,{children:["Cypress does not instrument your code - you need to do it yourself. The golden\nstandard for JavaScript code instrumentation is the battle-hardened\n",(0,s.jsx)(n.a,{href:"https://istanbul.js.org",children:"Istanbul"})," and, luckily, it plays very nicely with the\nCypress. You can instrument the code as a build step through one of two ways:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Using the ",(0,s.jsx)(n.a,{href:"https://github.com/istanbuljs/nyc",children:"nyc"})," module - a command-line\ninterface for the ",(0,s.jsx)(n.a,{href:"https://istanbul.js.org",children:"Istanbul"})," library"]}),"\n",(0,s.jsxs)(n.li,{children:["As part of your code transpilation pipeline using the\n",(0,s.jsx)(n.a,{href:"https://github.com/istanbuljs/babel-plugin-istanbul",children:(0,s.jsx)(n.code,{children:"babel-plugin-istanbul"})}),"\ntool."]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"Using-NYC",children:"Using NYC"}),"\n",(0,s.jsxs)(n.p,{children:["To instrument the application code located in your ",(0,s.jsx)(n.code,{children:"src"})," folder and save it in\nan ",(0,s.jsx)(n.code,{children:"instrumented"})," folder use the following command:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"npx nyc instrument --compact=false src instrumented\n"})}),"\n",(0,s.jsxs)(n.p,{children:["We are passing the ",(0,s.jsx)(n.code,{children:"--compact=false"})," flag to generate human-friendly output."]}),"\n",(0,s.jsx)(n.p,{children:"The instrumentation takes your original code like this fragment..."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",metastring:"title='src/index.js'",children:"const store = createStore(reducer)\n\nrender(\n  <Provider store={store}>\n    <App />\n  </Provider>,\n  document.getElementById('root')\n)\n"})}),"\n",(0,s.jsx)(n.p,{children:"...and wraps each statement with additional counters that keep track of how many\ntimes each source line has been executed by the JavaScript runtime."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"const store = (cov_18hmhptych.s[0]++, createStore(reducer))\ncov_18hmhptych.s[1]++\nrender(\n  <Provider store={store}>\n    <App />\n  </Provider>,\n  document.getElementById('root')\n)\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Notice the calls to ",(0,s.jsx)(n.code,{children:"cov_18hmhptych.s[0]++"})," and ",(0,s.jsx)(n.code,{children:"cov_18hmhptych.s[1]++"})," that\nincrement the statement counters. All counters and additional book-keeping\ninformation is stored in a single object attached to the browser's ",(0,s.jsx)(n.code,{children:"window"}),"\nobject. We can see the counters if we serve the ",(0,s.jsx)(n.code,{children:"instrumented"})," folder instead of\n",(0,s.jsx)(n.code,{children:"src"})," and open the application."]}),"\n",(0,s.jsx)(r,{src:"/img/app/code-coverage/coverage-object.png",alt:"Code coverage object"}),"\n",(0,s.jsxs)(n.p,{children:["If we drill into the coverage object we can see the statements executed in each\nfile. For example the file ",(0,s.jsx)(n.code,{children:"src/index.js"})," has the following information:"]}),"\n",(0,s.jsx)(r,{src:"/img/app/code-coverage/coverage-statements.png",alt:"Covered statements counters in a from the index file"}),"\n",(0,s.jsxs)(n.p,{children:["In green, we highlighted the 4 statements present in that file. The first three\nstatements were each executed once and the last statement was never executed (it\nprobably was inside an ",(0,s.jsx)(n.code,{children:"if"})," statement). By using the application, we can both\nincrement the counters and flip some of the zero counters into positive numbers."]}),"\n",(0,s.jsx)(n.h3,{id:"Using-code-transpilation-pipeline",children:"Using code transpilation pipeline"}),"\n",(0,s.jsxs)(n.p,{children:["Instead of using the ",(0,s.jsx)(n.code,{children:"npx instrument"})," command, we can use\n",(0,s.jsx)(n.a,{href:"https://github.com/istanbuljs/babel-plugin-istanbul",children:(0,s.jsx)(n.code,{children:"babel-plugin-istanbul"})}),"\nto instrument the code as part of its transpilation. Add this plugin to the\n",(0,s.jsx)(n.code,{children:".babelrc"})," file."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",metastring:"title='.babelrc'\"",children:'{\n  "presets": ["@babel/preset-react"],\n  "plugins": ["transform-class-properties", "istanbul"]\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["We can now serve the application and get instrumented code without an\nintermediate folder, but the result is the same instrumented code loaded by the\nbrowser, with the same ",(0,s.jsx)(n.code,{children:"window.__coverage__"})," object keeping track of the\noriginal statements."]}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:["Check out\n",(0,s.jsx)(n.a,{href:"https://github.com/cypress-io/code-coverage#examples",children:(0,s.jsx)(n.code,{children:"@cypress/code-coverage#examples"})}),"\nfor full example projects showing different code coverage setups."]})}),"\n",(0,s.jsx)(r,{src:"/img/app/code-coverage/source-map.png",alt:"Bundled code and source mapped originals"}),"\n",(0,s.jsxs)(n.p,{children:["A really nice feature of both ",(0,s.jsx)(n.a,{href:"https://github.com/istanbuljs/nyc",children:"nyc"})," and\n",(0,s.jsx)(n.a,{href:"https://github.com/istanbuljs/babel-plugin-istanbul",children:(0,s.jsx)(n.code,{children:"babel-plugin-istanbul"})}),"\nis that the source maps are generated automatically, allowing us to collect code\ncoverage information, but also interact with the original, non-instrumented code\nin the Developer Tools. In the screenshot above the bundle (green arrow) has\ncoverage counters, but the source mapped files in the green rectangle show the\noriginal code."]}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"nyc"})," and ",(0,s.jsx)(n.code,{children:"babel-plugin-istanbul"})," only instrument the application code and\nnot 3rd party dependencies from ",(0,s.jsx)(n.code,{children:"node_modules"}),"."]})}),"\n",(0,s.jsx)(n.h2,{id:"E2E-code-coverage",children:"E2E code coverage"}),"\n",(0,s.jsxs)(n.p,{children:["To handle code coverage collected during each test, there is a\n",(0,s.jsx)(n.a,{href:"https://github.com/cypress-io/code-coverage",children:(0,s.jsx)(n.code,{children:"@cypress/code-coverage"})})," Cypress\nplugin. It merges coverage from each test and saves the combined result. It also\ncalls ",(0,s.jsx)(n.code,{children:"nyc"})," (its peer dependency) to generate static HTML reports for human\nconsumption."]}),"\n",(0,s.jsx)(n.h3,{id:"Install-the-plugin",children:"Install the plugin"}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:["Please consult the\n",(0,s.jsx)(n.a,{href:"https://github.com/cypress-io/code-coverage",children:(0,s.jsx)(n.code,{children:"@cypress/code-coverage"})}),"\ndocumentation for up-to-date installation instructions."]})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"npm install @cypress/code-coverage --save-dev\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Then add the code below to the\n",(0,s.jsx)(n.a,{href:"/app/references/configuration#e2e",children:"supportFile"})," and\n",(0,s.jsx)(n.a,{href:"/app/plugins/plugins-guide#Using-a-plugin",children:"setupNodeEvents"})," function."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"// cypress/support/e2e.js\nimport '@cypress/code-coverage/support'\n"})}),"\n",(0,s.jsxs)(t,{children:[(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",metastring:"",children:"const { defineConfig } = require('cypress')\n\nmodule.exports = defineConfig({\n  // setupNodeEvents can be defined in either\n  // the e2e or component configuration\n  e2e: {\n    setupNodeEvents(on, config) {\n      require('@cypress/code-coverage/task')(on, config)\n      // include any other plugin code...\n\n      // It's IMPORTANT to return the config object\n      // with any changed environment variables\n      return config\n    },\n  },\n})\n"})}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",metastring:"",children:"import { defineConfig } from 'cypress'\n\nexport default defineConfig({\n  // setupNodeEvents can be defined in either\n  // the e2e or component configuration\n  e2e: {\n    setupNodeEvents(on, config) {\n      require('@cypress/code-coverage/task')(on, config)\n      // include any other plugin code...\n\n      // It's IMPORTANT to return the config object\n      // with any changed environment variables\n      return config\n    },\n  },\n})\n"})})]}),"\n",(0,s.jsx)(n.p,{children:"When you run the Cypress tests now, you should see a few commands after the\ntests finish. We have highlighted these commands using a green rectangle below."}),"\n",(0,s.jsx)(r,{src:"/img/app/code-coverage/coverage-plugin-commands.png",alt:"coverage plugin commands"}),"\n",(0,s.jsxs)(n.p,{children:["After the tests complete, the final code coverage is saved to a ",(0,s.jsx)(n.code,{children:".nyc_output"}),"\nfolder. It is a JSON file from which we can generate a report in a variety of\nformats. The\n",(0,s.jsx)(n.a,{href:"https://github.com/cypress-io/code-coverage",children:(0,s.jsx)(n.code,{children:"@cypress/code-coverage"})})," plugin\ngenerates the HTML report automatically - you can open the ",(0,s.jsx)(n.code,{children:"coverage/index.html"}),"\npage locally after the tests finish. You can also call ",(0,s.jsx)(n.code,{children:"nyc report"})," to generate\nother reports, for example, sending the coverage information to 3rd party\nservices."]}),"\n",(0,s.jsx)(n.h3,{id:"See-code-coverage-summary",children:"See code coverage summary"}),"\n",(0,s.jsx)(n.p,{children:"To see the summary of the code coverage after tests run, run the command below."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell",children:"npx nyc report --reporter=text-summary\n\n========= Coverage summary =======\nStatements   : 76.3% ( 103/135 )\nBranches     : 65.31% ( 32/49 )\nFunctions    : 64% ( 32/50 )\nLines        : 81.42% ( 92/113 )\n==================================\n"})}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Tip:"})," store the ",(0,s.jsx)(n.code,{children:"coverage"})," folder as a build artifact on your continuous\nintegration server. Because the report is a static HTML page, some CIs can show\nit right from their web applications. The screenshot below shows the coverage\nreport stored on CircleCI. Clicking on ",(0,s.jsx)(n.code,{children:"index.html"})," shows the report right in\nthe browser."]})}),"\n",(0,s.jsx)(r,{src:"/img/app/code-coverage/circleci-coverage-report.png",alt:"coverage HTML report on CircleCI"}),"\n",(0,s.jsx)(n.h2,{id:"Code-coverage-as-a-guide",children:"Code coverage as a guide"}),"\n",(0,s.jsx)(n.p,{children:"Even a single test can cover a lot of the application code. For example, let's\nrun the following test that adds a few items, then marks one of them as\ncompleted."}),"\n",(0,s.jsxs)(i,{children:[(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"it('adds and completes todos', () => {\n  cy.visit('/')\n  cy.get('.new-todo')\n    .type('write code{enter}')\n    .type('write tests{enter}')\n    .type('deploy{enter}')\n\n  cy.get('.todo').should('have.length', 3)\n\n  cy.get('.todo').first().find('.toggle').check()\n\n  cy.get('.todo').first().should('have.class', 'completed')\n})\n"})}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"it('adds and completes todos', () => {\n  cy.mount(<AddTodo />)\n  cy.get('.new-todo')\n    .type('write code{enter}')\n    .type('write tests{enter}')\n    .type('deploy{enter}')\n\n  cy.get('.todo').should('have.length', 3)\n\n  cy.get('.todo').first().find('.toggle').check()\n\n  cy.get('.todo').first().should('have.class', 'completed')\n})\n"})})]}),"\n",(0,s.jsx)(n.p,{children:"After running the test and opening the HTML report, we see 76% code coverage in\nour application."}),"\n",(0,s.jsx)(r,{src:"/img/app/code-coverage/single-test.png",alt:"Coverage report after a single test"}),"\n",(0,s.jsxs)(n.p,{children:["Even better, we can drill down into the individual source files to see what code\nwe missed. In our example application, the main state logic is in the\n",(0,s.jsx)(n.code,{children:"src/reducers/todos.js"})," file. Let's see the code coverage in this file:"]}),"\n",(0,s.jsx)(r,{src:"/img/app/code-coverage/todos-coverage.png",alt:"Main application logic coverage"}),"\n",(0,s.jsxs)(n.p,{children:["Notice how the ",(0,s.jsx)(n.strong,{children:"ADD_TODO"})," action was executed 3 times - because our test has\nadded 3 todo items, and the ",(0,s.jsx)(n.strong,{children:"COMPLETE_TODO"})," action was executed just once -\nbecause our test has marked 1 todo item as completed."]}),"\n",(0,s.jsxs)(n.p,{children:["The source lines not covered marked in yellow (the switch cases the test missed)\nand red (regular statements) are a great guide for writing more end-to-end\ntests. We need tests that delete todo items, edit them, mark all of them as\ncompleted at once and clear completed items. When we cover every switch\nstatement in ",(0,s.jsx)(n.code,{children:"src/reducers/todos.js"})," we probably will achieve close to 100% code\ncoverage. Even more importantly, we will cover the main features of the\napplication the user is expected to use."]}),"\n",(0,s.jsx)(n.p,{children:"We can write more E2E tests."}),"\n",(0,s.jsx)(r,{src:"/img/app/code-coverage/more-tests.png",alt:"Cypress passed more tests"}),"\n",(0,s.jsx)(n.p,{children:"The produced HTML report shows 99% code coverage"}),"\n",(0,s.jsx)(r,{src:"/img/app/code-coverage/almost-100.png",alt:"99 percent code coverage"}),"\n",(0,s.jsx)(n.p,{children:"Every source file but 1 is covered at 100%. We can have great confidence in our\napplication, and safely refactor the code knowing that we have a robust set of\nend-to-end tests."}),"\n",(0,s.jsxs)(n.p,{children:["If possible, we advise implementing\n",(0,s.jsx)(n.a,{href:"/app/tooling/visual-testing",children:"visual testing"})," in addition to Cypress\nfunctional tests to avoid CSS and visual regressions."]}),"\n",(0,s.jsx)(n.h2,{id:"Combining-code-coverage-from-parallel-tests",children:"Combining code coverage from parallel tests"}),"\n",(0,s.jsxs)(n.p,{children:["If you execute Cypress tests in\n",(0,s.jsx)(n.a,{href:"/cloud/features/smart-orchestration/parallelization",children:"parallel"}),", each machine ends\nup with a code coverage report that only shows a portion of the code exercised.\nTypically an external code coverage service would merge such partial reports for\nyou. If you do want to merge the reports yourself:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"on every machine running Cypress tests, copy the produced code coverage report\ninto a common folder under a unique name to avoid overwriting it"}),"\n",(0,s.jsxs)(n.li,{children:["after all E2E tests finish, combine the reports yourself using ",(0,s.jsx)(n.code,{children:"nyc merge"}),"\ncommand"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["You can find an example of merging partial reports in our\n",(0,s.jsx)(n.a,{href:"https://github.com/cypress-io/cypress-example-conduit-app",children:"cypress-io/cypress-example-conduit-app"})]}),"\n",(0,s.jsx)(n.h2,{id:"E2E-and-unit-code-coverage",children:"E2E and unit code coverage"}),"\n",(0,s.jsxs)(n.p,{children:['Let\'s look at the one file that has a "missed" line. It is the\n',(0,s.jsx)(n.code,{children:"src/selectors/index.js"})," file shown below."]}),"\n",(0,s.jsx)(r,{src:"/img/app/code-coverage/selectors.png",alt:"Selectors file with a line not covered by end-to-end tests"}),"\n",(0,s.jsx)(n.p,{children:"The source line not covered by the end-to-end tests shows an edge case NOT\nreachable from the UI. Yet this switch case is definitely worth testing - at\nleast to avoid accidentally changing its behavior during future refactoring."}),"\n",(0,s.jsxs)(n.p,{children:["We can directly test this piece of code by importing the ",(0,s.jsx)(n.code,{children:"getVisibleTodos"}),"\nfunction from the Cypress spec file. In essence we are using Cypress as a unit\ntesting tool (find more unit testing recipes\n",(0,s.jsx)(n.a,{href:"https://github.com/cypress-io/cypress-example-recipes#unit-testing",children:"here"}),")."]}),"\n",(0,s.jsx)(n.p,{children:"Here is our test to confirm that the error is thrown."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"// cypress/e2e/selectors.cy.js\nimport { getVisibleTodos } from '../../src/selectors'\n\ndescribe('getVisibleTodos', () => {\n  it('throws an error for unknown visibility filter', () => {\n    expect(() => {\n      getVisibleTodos({\n        todos: [],\n        visibilityFilter: 'unknown-filter',\n      })\n    }).to.throw()\n  })\n})\n"})}),"\n",(0,s.jsx)(n.p,{children:"The test passes, even if there is no web application visited."}),"\n",(0,s.jsx)(r,{src:"/img/app/code-coverage/unit-test.png",alt:"Unit test for selector"}),"\n",(0,s.jsx)(n.p,{children:"Previously we instrumented the application code (either using a build step or\ninserting a plugin into the Babel pipeline). In the example above, we are NOT\nloading an application, instead we are only running the test files by\nthemselves."}),"\n",(0,s.jsxs)(n.p,{children:["If we want to collect the code coverage from the unit tests, we need to\ninstrument the source code of ",(0,s.jsx)(n.em,{children:"our spec files"}),". The simplest way to do this is\nto use the same ",(0,s.jsx)(n.code,{children:".babelrc"})," with\n",(0,s.jsx)(n.a,{href:"https://github.com/istanbuljs/babel-plugin-istanbul",children:(0,s.jsx)(n.code,{children:"babel-plugin-istanbul"})}),"\nand tell the Cypress built-in bundler to use ",(0,s.jsx)(n.code,{children:".babelrc"})," when bundling specs. One\ncan use the\n",(0,s.jsx)(n.a,{href:"https://github.com/cypress-io/code-coverage",children:(0,s.jsx)(n.code,{children:"@cypress/code-coverage"})})," plugin\nagain to do this by adding the code below to the\n",(0,s.jsx)(n.a,{href:"/app/plugins/plugins-guide#Using-a-plugin",children:"setupNodeEvents"})," function."]}),"\n",(0,s.jsxs)(t,{children:[(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",metastring:"",children:"const { defineConfig } = require('cypress')\n\nmodule.exports = defineConfig({\n  // setupNodeEvents can be defined in either\n  // the e2e or component configuration\n  e2e: {\n    setupNodeEvents(on, config) {\n      require('@cypress/code-coverage/task')(on, config)\n      // tell Cypress to use .babelrc file\n      // and instrument the specs files\n      // only the extra application files will be instrumented\n      // not the spec files themselves\n      on('file:preprocessor', require('@cypress/code-coverage/use-babelrc'))\n\n      return config\n    },\n  },\n})\n"})}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",metastring:"",children:"import { defineConfig } from 'cypress'\n\nexport default defineConfig({\n  // setupNodeEvents can be defined in either\n  // the e2e or component configuration\n  e2e: {\n    setupNodeEvents(on, config) {\n      require('@cypress/code-coverage/task')(on, config)\n      // tell Cypress to use .babelrc file\n      // and instrument the specs files\n      // only the extra application files will be instrumented\n      // not the spec files themselves\n      on('file:preprocessor', require('@cypress/code-coverage/use-babelrc'))\n\n      return config\n    },\n  },\n})\n"})})]}),"\n",(0,s.jsxs)(n.p,{children:["For reference, the ",(0,s.jsx)(n.code,{children:".babelrc"})," file is shared between the example application and\nthe spec files, thus Cypress tests are transpiled the same way the application\ncode is transpiled."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "presets": ["@babel/preset-react"],\n  "plugins": ["transform-class-properties", "istanbul"]\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["When we run Cypress with\n",(0,s.jsx)(n.a,{href:"https://github.com/istanbuljs/babel-plugin-istanbul",children:(0,s.jsx)(n.code,{children:"babel-plugin-istanbul"})}),"\nincluded and inspect the ",(0,s.jsx)(n.code,{children:"window.__coverage__"})," object in the ",(0,s.jsx)(n.strong,{children:"spec iframe"}),", we\nshould see the coverage information for the application source files."]}),"\n",(0,s.jsx)(r,{src:"/img/app/code-coverage/code-coverage-in-unit-test.png",alt:"Code coverage in the unit test"}),"\n",(0,s.jsxs)(n.p,{children:["The code coverage information in unit tests and end-to-end tests has the same\nformat; the\n",(0,s.jsx)(n.a,{href:"https://github.com/cypress-io/code-coverage",children:(0,s.jsx)(n.code,{children:"@cypress/code-coverage"})})," plugin\nautomatically grabs both and saves the combined report. Thus we can see the code\ncoverage from the ",(0,s.jsx)(n.code,{children:"cypress/e2e/selectors.cy.js"})," file after running the test."]}),"\n",(0,s.jsx)(r,{src:"/img/app/code-coverage/unit-test-coverage.png",alt:"Selectors code coverage"}),"\n",(0,s.jsx)(n.p,{children:"Our unit test is hitting the line we could not reach from the end-to-end tests,\nand if we execute all spec files - we will get 100% code coverage."}),"\n",(0,s.jsx)(r,{src:"/img/app/code-coverage/100percent.png",alt:"Full code coverage"}),"\n",(0,s.jsx)(n.h2,{id:"Full-stack-code-coverage",children:"Full stack code coverage"}),"\n",(0,s.jsx)(n.p,{children:"A complex application might have a Node back end with its own complex logic.\nFrom the front end web application, the calls to the API go through layers of\ncode. It would be nice to track what back end code has been exercised during\nCypress end-to-end tests."}),"\n",(0,s.jsx)(n.p,{children:"Are our end-to-end tests that are so effective at covering the web application\ncode also covering the back end server code?"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Long story short: yes."})," You can collect the code coverage from the back end,\nand let the ",(0,s.jsx)(n.code,{children:"@cypress/code-coverage"})," plugin merge it with the front end\ncoverage, creating a single full stack report."]}),"\n",(0,s.jsx)(n.admonition,{type:"info",children:(0,s.jsxs)(n.p,{children:["The full source code for this section can be found in the\n",(0,s.jsx)(n.a,{href:"https://github.com/cypress-io/cypress-example-conduit-app",children:"cypress-io/cypress-example-conduit-app"}),"\nrepository."]})}),"\n",(0,s.jsxs)(n.p,{children:['You can run your Node server and instrument it using nyc on the fly. Instead of\nthe "normal" server start command, you can run the command\n',(0,s.jsx)(n.code,{children:"npm run start:coverage"})," defined in the ",(0,s.jsx)(n.code,{children:"package.json"})," like this:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "scripts": {\n    "start": "node server",\n    "start:coverage": "nyc --silent node server"\n  }\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["In your server, insert another middleware from ",(0,s.jsx)(n.code,{children:"@cypress/code-coverage"}),". If you\nuse an Express server, include ",(0,s.jsx)(n.code,{children:"middleware/express"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"const express = require('express')\nconst app = express()\n\nrequire('@cypress/code-coverage/middleware/express')(app)\n"})}),"\n",(0,s.jsxs)(n.p,{children:["If your server uses hapi, include ",(0,s.jsx)(n.code,{children:"middleware/hapi"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"if (global.__coverage__) {\n  require('@cypress/code-coverage/middleware/hapi')(server)\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Tip:"})," you can conditionally register the endpoint only if there is a global\ncode coverage object, and you can\n",(0,s.jsx)(n.a,{href:"https://github.com/gotwarlost/istanbul/blob/master/ignoring-code-for-coverage.md",children:"exclude the middleware code from the coverage numbers"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"/* istanbul ignore next */\nif (global.__coverage__) {\n  require('@cypress/code-coverage/middleware/hapi')(server)\n}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["For any other server type, define a ",(0,s.jsx)(n.code,{children:"GET /__coverage__"})," endpoint and return the\n",(0,s.jsx)(n.code,{children:"global.__coverage__"})," object."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:'if (global.__coverage__) {\n  // handle "GET __coverage__" requests\n  onRequest = (response) => {\n    response.sendJSON({ coverage: global.__coverage__ })\n  }\n}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["In order for the ",(0,s.jsx)(n.code,{children:"@cypress/code-coverage"})," plugin to know that it should request\nthe back end coverage, add the new endpoint to the Cypress configuration\nenvironment settings under ",(0,s.jsx)(n.code,{children:"env.codeCoverage.url"}),' key. For example, if the\napplication back end is running at port 3000 and we are using the default "GET\n/',(0,s.jsx)(n.strong,{children:"coverage"}),'" endpoint, set the following:']}),"\n",(0,s.jsxs)(t,{children:[(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",metastring:"",children:"const { defineConfig } = require('cypress')\n\nmodule.exports = defineConfig({\n  env: {\n    codeCoverage: {\n      url: 'http://localhost:3000/__coverage__',\n    },\n  },\n})\n"})}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",metastring:"",children:"import { defineConfig } from 'cypress'\n\nexport default defineConfig({\n  env: {\n    codeCoverage: {\n      url: 'http://localhost:3000/__coverage__',\n    },\n  },\n})\n"})})]}),"\n",(0,s.jsxs)(n.p,{children:["From now on, the front end code coverage collected during end-to-end tests will\nbe merged with the code coverage from the instrumented back end code and saved\nin a single report. Here is an example report from the\n",(0,s.jsx)(n.a,{href:"https://github.com/cypress-io/cypress-example-conduit-app",children:"cypress-io/cypress-example-conduit-app"}),"\nexample:"]}),"\n",(0,s.jsx)(r,{src:"/img/app/code-coverage/full-coverage.png",alt:"Combined code coverage report from front and back end code"}),"\n",(0,s.jsxs)(n.p,{children:["You can explore the above combined full stack coverage report at the\n",(0,s.jsx)(n.a,{href:"https://coveralls.io/github/cypress-io/cypress-example-conduit-app",children:"coveralls.io/github/cypress-io/cypress-example-conduit-app"}),"\ndashboard. You can also find full stack code coverage in our\n",(0,s.jsx)(n.a,{href:"https://github.com/cypress-io/cypress-realworld-app",children:"RealWorld App"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"Even if you only want to measure the back end code coverage Cypress can help."}),"\n",(0,s.jsx)(n.h2,{id:"Videos",children:"Videos"}),"\n",(0,s.jsx)(n.p,{children:"There is a series of videos we have recorded showing code coverage in Cypress"}),"\n",(0,s.jsx)(n.h4,{id:"How-to-instrument-react-scripts-web-application-for-code-coverage",children:"How to instrument react-scripts web application for code coverage"}),"\n",(0,s.jsx)(c,{src:"https://youtube.com/embed/edgeQZ8UpD0",title:"How to instrument react-scripts web application for code coverage"}),"\n",(0,s.jsx)(n.h4,{id:"Get-code-coverage-reports-from-Cypress-tests",children:"Get code coverage reports from Cypress tests"}),"\n",(0,s.jsx)(c,{src:"https://youtube.com/embed/y8StkffYra0",title:"Get code coverage reports from Cypress tests"}),"\n",(0,s.jsx)(n.h4,{id:"Excluding-code-from-code-coverage-reports",children:"Excluding code from code coverage reports"}),"\n",(0,s.jsx)(c,{src:"https://youtube.com/embed/DlceMpRpbAw",title:"Excluding code from code coverage reports"}),"\n",(0,s.jsx)(n.h4,{id:"Check-code-coverage-robustly-using-3rd-party-tool",children:"Check code coverage robustly using 3rd party tool"}),"\n",(0,s.jsx)(c,{src:"https://youtube.com/embed/dwU5gUG2",title:"Check code coverage robustly using 3rd party tool"}),"\n",(0,s.jsx)(n.h4,{id:"Adding-code-coverage-badge-to-your-project",children:"Adding code coverage badge to your project"}),"\n",(0,s.jsx)(c,{src:"https://youtube.com/embed/bNVRxb-MKGo",title:"Adding code coverage badge to your project"}),"\n",(0,s.jsx)(n.h4,{id:"Show-code-coverage-in-commit-status-check",children:"Show code coverage in commit status check"}),"\n",(0,s.jsx)(c,{src:"https://youtube.com/embed/AAl4HmJ3YuM",title:"Show code coverage in commit status check"}),"\n",(0,s.jsx)(n.h4,{id:"Checking-code-coverage-on-pull-request",children:"Checking code coverage on pull request"}),"\n",(0,s.jsx)(c,{src:"https://youtube.com/embed/9Eq_gIshK0o",title:"Checking code coverage on pull request"}),"\n",(0,s.jsx)(n.h2,{id:"Examples",children:"Examples"}),"\n",(0,s.jsx)(n.p,{children:"You can find full examples showing different code coverage setups in the\nfollowing repositories:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://github.com/cypress-io/cypress-realworld-app",children:"cypress-io/cypress-realworld-app"}),"\nor RWA is a full stack example application that demonstrates ",(0,s.jsx)(n.strong,{children:"best practices\nand scalable strategies with Cypress in practical and realistic scenarios"}),".\nThe RWA achieves full code coverage with end-to-end tests\n",(0,s.jsx)(n.a,{href:"/app/guides/cross-browser-testing",children:"across multiple browsers"})," and\n",(0,s.jsx)(n.a,{href:"/api/commands/viewport",children:"device sizes"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://github.com/lluia/cypress-typescript-coverage-example",children:"lluia/cypress-typescript-coverage-example"}),"\nshows coverage for a React App that uses TypeScript."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://github.com/ericorruption/cypress-code-coverage-typescript-webpack-ts-loader",children:"ericorruption/cypress-code-coverage-typescript-webpack-ts-loader"}),"\nshows how to collect coverage for a TypeScript + webpack project using\n",(0,s.jsx)(n.code,{children:"ts-loader"})," instead of ",(0,s.jsx)(n.code,{children:"babel-loader"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Find the full list of examples linked in\n",(0,s.jsx)(n.a,{href:"https://github.com/cypress-io/code-coverage#external-examples",children:"cypress-io/code-coverage#external-examples"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"See-also",children:"See also"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"/ui-coverage/get-started/introduction",children:"UI Coverage"})}),"\n",(0,s.jsxs)(n.li,{children:["The official\n",(0,s.jsx)(n.a,{href:"https://github.com/cypress-io/code-coverage",children:"@cypress/code-coverage"})," plugin"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}function p(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}},1151:(e,n,t)=>{t.d(n,{Z:()=>i,a:()=>c});var s=t(7294);const o={},r=s.createContext(o);function c(e){const n=s.useContext(r);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:c(e.components),s.createElement(r.Provider,{value:n},e.children)}}}]);